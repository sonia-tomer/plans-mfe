<div class="subscription-modal-container" [class.closing]="isClosing">
  <!-- Confetti overlay on payment success -->
  <div *ngIf="showConfetti" class="confetti-overlay">
    <img
      src="https://i.pinimg.com/originals/07/03/48/0703483f8e3100d87497817030fb903f.gif"
      alt="Payment Success"
      class="confetti-image"
    />
  </div>
  <button class="subscription-modal-close" (click)="onContinueWithCurrent()">
    ×
  </button>

  <!-- Initial view: plan cards + CTA (hidden for downgrade flow with autoStartMandate) -->
  <div *ngIf="!qrCode && showIntro">
    <div class="subscription-modal-header">
      <h2 class="subscription-modal-title">
        Save upto <span class="highlight">10% on each shipment</span>
      </h2>
      <p class="subscription-modal-subtitle">
        Upgrade to
        <span class="font-semibold">{{ plan?.name || 'Business Plan' }}</span>
        and get cheaper shipping rates.
      </p>
    </div>

    <div class="subscription-modal-body">
      <!-- Plans summary (top section, same as SR_Web style) -->
      <div class="subscription-plan-card">
        <div class="subscription-plan-current">
          <div class="plan-label">
            Current Plan
            <span *ngIf="currentPlan?.name"> – {{ currentPlan?.name }}</span>
          </div>
          <div class="plan-price">
            {{ currentPlan?.priceDisplay || '₹0 / month' }}
          </div>
          <p class="plan-desc">
            Pay higher shipping rates on each shipment.
          </p>
        </div>

        <div class="subscription-plan-upgrade">
          <div class="plan-badge">Recommended</div>
          <div class="plan-label">
            {{ plan?.name || 'Business Plan' }}
          </div>
          <div class="plan-price">
            {{ plan?.priceDisplay || '₹99 / month' }}
          </div>
          <p class="plan-desc saving">
            Save upto 10% on each shipment.
          </p>
        </div>
      </div>

      <!-- If mandate not started yet OR timed out → show CTA buttons -->
      <div
        class="subscription-modal-actions"
        *ngIf="paymentStatus === 'idle' || paymentStatus === 'timeout' || !qrCode"
      >
        <button
          type="button"
          class="btn-upgrade"
          (click)="onUpgrade()"
        >
          {{ paymentStatus === 'timeout' ? 'Retry & Generate QR Code' : 'Upgrade & Activate Plan' }}
        </button>

        <button
          type="button"
          class="btn-outline"
          (click)="onContinueWithCurrent()"
        >
          Continue with current plan
        </button>
      </div>
    </div>
  </div>

  <!-- Loader view while mandate is being initiated (mainly for downgrade auto-start flow) -->
  <div *ngIf="!qrCode && !showIntro && isInitiatingMandate" class="subscription-modal-body">
    <div class="loader-container">
      <div class="loader-spinner"></div>
      <p class="loader-text">Generating secure UPI mandate…</p>
    </div>
  </div>

  <!-- Pure QR view once mandate is created -->
  <div *ngIf="qrCode" class="subscription-modal-body">
      <div class="qr-section">
        <div class="qr-left">
          <div class="qr-header">
            <h3 class="qr-title">
              Scan QR with any UPI app
            </h3>
            <p class="qr-subtitle">
              Approve monthly mandate of
              <span class="qr-amount">
                ₹{{ mandateAmount || plan?.price || 0 }}
                <span *ngIf="currency"> {{ currency }}</span>
              </span>
            </p>
          </div>

          <div class="qr-meta-card">
            <div class="qr-meta-title">Payment Details</div>
            <div class="qr-meta-grid">
              <div class="qr-meta-item">
                <span class="meta-label">Merchant</span>
                <span class="meta-value">{{ merchantName }}</span>
              </div>
              <div class="qr-meta-item">
                <span class="meta-label">VPA</span>
                <span class="meta-value">{{ merchantVpa }}</span>
              </div>
              <div *ngIf="mandateAmount" class="qr-meta-item">
                <span class="meta-label">Amount</span>
                <span class="meta-value">₹{{ mandateAmount }} <span *ngIf="currency">({{ currency }})</span></span>
              </div>
              <div class="qr-meta-item">
                <span class="meta-label">From</span>
                <span class="meta-value">{{ fromDate }}</span>
              </div>
              <div class="qr-meta-item">
                <span class="meta-label">To</span>
                <span class="meta-value">{{ toDate }}</span>
              </div>
              <div class="qr-meta-item">
                <span class="meta-label">Frequency</span>
                <span class="meta-value">{{ frequency }}</span>
              </div>
              <div *ngIf="shortLink" class="qr-meta-item qr-meta-item-full">
                <span class="meta-label">UPI Link</span>
                <span class="meta-value meta-value-link">{{ shortLink }}</span>
              </div>
            </div>
          </div>

          <div class="timer-card">
            <div class="timer-icon">⏱️</div>
            <div class="timer-content">
              <span class="time">{{ formatTime(timeRemaining) }}</span>
              <span class="timer-label">Time remaining</span>
            </div>
          </div>
        </div>

        <div class="qr-right">
          <div class="qr-container">
            <img
              [src]="'data:image/png;base64,' + qrCode"
              alt="UPI QR Code"
              class="qr-img"
            />
            <div class="qr-instruction">Scan to pay with UPI</div>
          </div>
        </div>
      </div>
    </div>
</div>

